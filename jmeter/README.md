# Apache JMeter Trial Image

The [Apache JMeter](https://jmeter.apache.org/) trial job leverages a custom JMeter container image, based on the `openjdk:20-slim-bullseye` base image and the official Apache JMeter [version 5.5 distribution](https://jmeter.apache.org/download_jmeter.cgi).
The image will check to make sure the provided test plan file exists prior to launching JMeter.
It is expected that the provided test plan file is a valid JMeter test plan compatible with JMeter version 5.5.
Please note that this trial job does not include any JMeter plugins other than those that are included with the official JMeter releases.

## Usage

- Mount volume with `test.jmx` into `/test`.
- Configure Trial to use either `prometheus` setupTask or manually define `PUSHGATEWAY_URL`.

## Configuration

| Environment Variable | Description | Default |
| -------------------- | ----------- | ------- |
| `JMETER_TEST_PLAN_FILE`     | Path to the JMeter test plan. | `/test/test.jmx` |
| `PUSHGATEWAY_URL`    | The URL used push StormForge Performance test run metrics. | |
| `JMETER_ARGS`        | Allows passing additional arguments to `jmeter`, e.g. to define properties. | |

## Metrics

Metrics are extracted from the `statistics.json` generated by the JMeter report.
This file contains calculated statistics based on all requests executed in the test plan.

| Name | Example Value | Note |
| ---- | ------------- | ---- |
| `errorCount` | `0` | |
| `errorPct` | `0` | |
| `maxResTime` | `269` | |
| `meanResTime` | `145.86999999999992` | |
| `medianResTime` | `150` | |
| `minResTime` | `94` | |
| `pct1ResTime` | `196.9` | Corresponds to the 90th percentile |
| `pct2ResTime` | `198` | Corresponds to the 95th percentile |
| `pct3ResTime` | `267.60000000000036` | Corresponds to the 99th percentile |
| `receivedKBytesPerSec` | `8.475751945331206` | |
| `sampleCount` | `200` | |
| `sentKBytesPerSec` | `3.370816290901836` | |
| `throughput` | `19.952114924181963` | |

## Example Kubernetes Manifest

The following Kubernetes Job manifest illustrates how you might leverage this trial job container.

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: sandbox-1
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: black-friday
        image: thestormforge/optimize-trials:latest-jmeter
        env:
        - name: PUSHGATEWAY_URL
          value: http://pushgateway:9091/metrics/job/trialRun/instance/sandbox-1
        volumeMounts:
        - mountPath: /test
          name: jmeter-test-case-file
          readOnly: true
      volumes:
      - name: jmeter-test-case-file
        configMap:
          name: jmeter-test-case
```

NOTE: If you are using this in an experiment, keep in mind that some values are set automatically. In particular, the `backoffLimit`, `restartPolicy`, and `PUSHGATEWAY_URL` environment variable are all introduced when evaluating a trial's job template.
PUSHGATEWAY_URL requires the use of the `prometheus` setupTask.
